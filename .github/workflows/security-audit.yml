# Comprehensive Security Audit - Scheduled
# This workflow runs comprehensive security scans on a schedule to avoid blocking deployments

name: Comprehensive Security Audit

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  workflow_dispatch:  # Allow manual triggering
    inputs:
      scan_depth:
        description: 'Scan depth for vulnerability analysis'
        required: false
        default: '30'
        type: string
      severity_threshold:
        description: 'Minimum severity level to report'
        required: false
        default: 'medium'
        type: choice
        options:
          - low
          - medium
          - high
          - critical

env:
  REGISTRY: docker.io
  IMAGE_NAME: zx8086/authentication-v2

jobs:
  comprehensive-security-audit:
    runs-on: ubuntu-latest
    timeout-minutes: 60  # Extended timeout for comprehensive scans
    permissions:
      contents: read
      security-events: write
      issues: write  # For creating security issues

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        timeout-minutes: 3

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        timeout-minutes: 5
        with:
          bun-version: latest

      - name: Cache Bun dependencies
        uses: actions/cache@v4
        timeout-minutes: 3
        with:
          path: |
            ~/.bun/install/cache
            node_modules
          key: ${{ runner.os }}-bun-${{ hashFiles('**/bun.lockb', '**/package.json') }}
          restore-keys: |
            ${{ runner.os }}-bun-

      - name: Install dependencies
        run: bun install --frozen-lockfile
        timeout-minutes: 5

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        timeout-minutes: 3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Comprehensive Snyk Code Analysis
      - name: Run comprehensive Snyk code analysis
        timeout-minutes: 10
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "Running comprehensive Snyk code analysis..."
          if [ -z "$SNYK_TOKEN" ]; then
            echo "ERROR: SNYK_TOKEN not configured"
            exit 0
          fi
          bunx snyk@1.1290.0 --version
          bunx snyk@1.1290.0 auth $SNYK_TOKEN
          bunx snyk@1.1290.0 code test --severity-threshold=${{ inputs.severity_threshold || 'medium' }} --sarif-file-output=snyk-code-comprehensive.sarif || {
            echo "Snyk code analysis completed with findings or errors"
            ls -la *.sarif 2>/dev/null || echo "No SARIF files found"
          }

          # Fix Snyk multi-run SARIF bug: ensure single run in SARIF file
          if [ -f "snyk-code-comprehensive.sarif" ]; then
            jq '.runs = [.runs[0]]' snyk-code-comprehensive.sarif > snyk-code-comprehensive-single.sarif
            mv snyk-code-comprehensive-single.sarif snyk-code-comprehensive.sarif
            echo "SARIF single-run fix applied"
          fi

          echo "Snyk code analysis completed"
        continue-on-error: true

      # Dependency Vulnerability Scan
      - name: Run Snyk dependency scan
        timeout-minutes: 15
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "Running Snyk dependency scan..."
          if [ -z "$SNYK_TOKEN" ]; then
            echo "ERROR: SNYK_TOKEN not configured"
            exit 0
          fi
          bunx snyk@1.1290.0 auth $SNYK_TOKEN
          bunx snyk@1.1290.0 test \
            --severity-threshold=${{ inputs.severity_threshold || 'medium' }} \
            --sarif-file-output=snyk-dependencies.sarif \
            --json > snyk-dependencies.json || true

          # Fix Snyk multi-run SARIF bug: ensure single run in SARIF file
          if [ -f "snyk-dependencies.sarif" ]; then
            jq '.runs = [.runs[0]]' snyk-dependencies.sarif > snyk-dependencies-single.sarif
            mv snyk-dependencies-single.sarif snyk-dependencies.sarif
            echo "SARIF single-run fix applied"
          fi

          bunx snyk@1.1290.0 monitor --project-name=authentication-service || true
        continue-on-error: true

      # Container Security Audit with Deep Scan
      - name: Pull latest image for comprehensive container scan
        run: |
          docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest || true
        timeout-minutes: 10
        continue-on-error: true

      - name: Run comprehensive Snyk container scan
        timeout-minutes: 15
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          echo "Running comprehensive Snyk container scan..."
          if [ -z "$SNYK_TOKEN" ]; then
            echo "ERROR: SNYK_TOKEN not configured"
            exit 0
          fi
          bunx snyk@1.1290.0 auth $SNYK_TOKEN
          bunx snyk@1.1290.0 container test ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            --severity-threshold=${{ inputs.severity_threshold || 'medium' }} \
            --sarif-file-output=snyk-container-comprehensive.sarif \
            --exclude-base-image-vulns || {
            echo "Snyk container scan completed with findings or errors"
            ls -la *.sarif 2>/dev/null || echo "No SARIF files found"
          }

          # Fix Snyk multi-run SARIF bug: ensure single run in SARIF file
          if [ -f "snyk-container-comprehensive.sarif" ]; then
            jq '.runs = [.runs[0]]' snyk-container-comprehensive.sarif > snyk-container-comprehensive-single.sarif
            mv snyk-container-comprehensive-single.sarif snyk-container-comprehensive.sarif
            echo "SARIF single-run fix applied"
          fi

          echo "Snyk container scan completed"
        continue-on-error: true

      # Advanced Trivy Scans
      - name: Run comprehensive Trivy filesystem scan
        uses: aquasecurity/trivy-action@0.34.0
        timeout-minutes: 15
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-fs-comprehensive.sarif'
          timeout: '10m'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
        continue-on-error: true

      - name: Run comprehensive Trivy container scan
        uses: aquasecurity/trivy-action@0.34.0
        timeout-minutes: 15
        with:
          image-ref: '${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest'
          format: 'sarif'
          output: 'trivy-container-comprehensive.sarif'
          timeout: '10m'
          severity: 'UNKNOWN,LOW,MEDIUM,HIGH,CRITICAL'
        continue-on-error: true

      # License Compliance Check (Bun Native)
      - name: Run comprehensive license compliance check
        run: |
          echo "Running comprehensive Bun native license compliance check..."
          bun scripts/license-check.ts --verbose --json > license-report.json || true
          echo "License compliance report generated"
          cat license-report.json || true
        timeout-minutes: 3
        continue-on-error: true

      # Secrets Detection
      - name: Run secrets detection with TruffleHog
        run: |
          curl -sSfL https://github.com/trufflesecurity/trufflehog/releases/download/v3.82.6/trufflehog_3.82.6_linux_amd64.tar.gz | tar -xzf - trufflehog
          ./trufflehog git file://. --json > secrets-scan.json || true
        timeout-minutes: 10
        continue-on-error: true

      # Upload all SARIF results to GitHub Security tab
      - name: Upload Snyk code analysis to GitHub Security
        if: hashFiles('snyk-code-comprehensive.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        timeout-minutes: 3
        with:
          sarif_file: 'snyk-code-comprehensive.sarif'
          category: 'snyk-code-comprehensive'
          wait-for-processing: true
        continue-on-error: true

      - name: Upload Snyk dependencies scan to GitHub Security
        if: hashFiles('snyk-dependencies.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        timeout-minutes: 3
        with:
          sarif_file: 'snyk-dependencies.sarif'
          category: 'snyk-dependencies-comprehensive'
          wait-for-processing: true
        continue-on-error: true

      - name: Upload Snyk container scan to GitHub Security
        if: hashFiles('snyk-container-comprehensive.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        timeout-minutes: 3
        with:
          sarif_file: 'snyk-container-comprehensive.sarif'
          category: 'snyk-container-comprehensive'
          wait-for-processing: true
        continue-on-error: true

      - name: Upload Trivy filesystem scan to GitHub Security
        if: hashFiles('trivy-fs-comprehensive.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        timeout-minutes: 3
        with:
          sarif_file: 'trivy-fs-comprehensive.sarif'
          category: 'trivy-fs-comprehensive'
          wait-for-processing: true
        continue-on-error: true

      - name: Upload Trivy container scan to GitHub Security
        if: hashFiles('trivy-container-comprehensive.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        timeout-minutes: 3
        with:
          sarif_file: 'trivy-container-comprehensive.sarif'
          category: 'trivy-container-comprehensive'
          wait-for-processing: true
        continue-on-error: true

      # Generate comprehensive security report with GitHub Step Summary
      - name: Generate comprehensive security report
        if: always()
        timeout-minutes: 5
        run: |
          {
            echo "## Comprehensive Security Audit Report"
            echo ""
            echo "**Audit Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo "**Repository:** ${{ github.repository }}"
            echo "**Commit:** \`${{ github.sha }}\`"
            echo "**Scan Depth:** ${{ inputs.scan_depth || '30' }}"
            echo "**Severity Threshold:** ${{ inputs.severity_threshold || 'medium' }}"
            echo ""
            echo "### Scan Results Summary"
            echo ""
            echo "| Scan Type | Status | SARIF File |"
            echo "|-----------|--------|------------|"

            # Check each scan result with status indicators
            for file in snyk-code-comprehensive.sarif snyk-dependencies.sarif snyk-container-comprehensive.sarif trivy-fs-comprehensive.sarif trivy-container-comprehensive.sarif; do
              scan_name="${file%-comprehensive.sarif}"
              scan_name="${scan_name%.sarif}"
              if [ -f "$file" ]; then
                echo "| $scan_name | Completed | $file |"
              else
                echo "| $scan_name | Failed | N/A |"
              fi
            done

            echo ""
            echo "### Additional Security Checks"
            echo ""

            # License compliance
            if [ -f "license-report.json" ]; then
              license_issues=$(jq 'length' license-report.json 2>/dev/null || echo "unknown")
              echo "| License Compliance | Issues: $license_issues | license-report.json |"
            else
              echo "| License Compliance | Passed | N/A |"
            fi

            # Secrets scan
            if [ -f "secrets-scan.json" ]; then
              secret_count=$(jq -s 'length' secrets-scan.json 2>/dev/null || wc -l < secrets-scan.json || echo "0")
              if [ "$secret_count" -gt 0 ]; then
                echo "| Secrets Detection | Found: $secret_count | secrets-scan.json |"
              else
                echo "| Secrets Detection | Passed | N/A |"
              fi
            else
              echo "| Secrets Detection | Passed | N/A |"
            fi

            echo ""
            echo "### Links"
            echo "- [Security Tab](https://github.com/${{ github.repository }}/security)"
            echo "- [Actions Run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            echo "- [Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}#artifacts)"
          } >> $GITHUB_STEP_SUMMARY

          # Also save to file for artifact
          cat $GITHUB_STEP_SUMMARY > security-report.md

      # Archive all security scan results
      - name: Archive comprehensive security scan results
        if: always()
        uses: actions/upload-artifact@v4
        timeout-minutes: 5
        with:
          name: comprehensive-security-audit-${{ github.run_number }}
          path: |
            *.sarif
            *.json
            *.txt
            *.md
          retention-days: 90

      # Create issue for critical vulnerabilities
      - name: Create security issue for critical findings
        if: always()
        timeout-minutes: 3
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check for critical vulnerabilities in SARIF files
          critical_found=false
          critical_details=""

          for sarif_file in *.sarif; do
            if [ -f "$sarif_file" ]; then
              # Simple check for critical severity (this could be enhanced with jq parsing)
              if grep -i "critical" "$sarif_file" > /dev/null 2>&1; then
                critical_found=true
                critical_details="$critical_details\n- Found in: $sarif_file"
              fi
            fi
          done

          if [ "$critical_found" = true ]; then
            # Create issue title with timestamp
            issue_title="Critical Security Vulnerabilities Detected - $(date -u '+%Y-%m-%d')"

            # Create issue body
            cat > issue_body.md << EOF
          ## Critical Security Vulnerabilities Detected

          **Audit Date:** $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          **Repository:** ${{ github.repository }}
          **Commit:** ${{ github.sha }}

          ### Critical Findings
          $critical_details

          ### Action Required
          - [ ] Review SARIF files in the [security audit artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          - [ ] Analyze each critical vulnerability
          - [ ] Create remediation plan
          - [ ] Apply security patches

          ### Artifact Location
          Download the complete security audit results from: [comprehensive-security-audit-${{ github.run_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *This issue was automatically created by the Comprehensive Security Audit workflow.*
          EOF

            # Create the issue
            gh issue create \
              --title "$issue_title" \
              --body-file issue_body.md \
              --label "security,critical,automated" \
              --assignee "${{ github.repository_owner }}" || true
          fi

      # Notify security team (optional - requires SLACK_WEBHOOK_URL secret)
      - name: Notify security team
        if: failure()
        timeout-minutes: 2
        run: |
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data '{"text":"Comprehensive Security Audit failed for ${{ github.repository }} - Check the workflow for details: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"}' \
              ${{ secrets.SLACK_WEBHOOK_URL }} || true
          fi
        continue-on-error: true