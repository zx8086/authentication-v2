name: DHI CVE Monitoring

on:
  schedule:
    # Run every 6 hours to check for new CVEs
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      force_scan:
        description: 'Force immediate CVE scan'
        required: false
        default: 'false'

permissions:
  contents: read
  issues: write
  security-events: write

jobs:
  dhi-cve-scan:
    name: DHI CVE Monitoring & SLA Tracking
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to DHI registry
        id: dhi_auth
        run: |
          # DHI uses Docker Hub credentials (Docker ID)
          # If using PAT, ensure it has at least "Read only" scope
          # If 2FA is enabled, PAT is required (not password)
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login dhi.io -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin && {
            echo "dhi_authenticated=true" >> $GITHUB_OUTPUT
            echo "Successfully authenticated to dhi.io"
          } || {
            echo "dhi_authenticated=false" >> $GITHUB_OUTPUT
            echo "::warning::Failed to authenticate to dhi.io - DHI uses Docker Hub credentials"
            echo "::warning::If using PAT, ensure it has 'Read only' scope minimum"
            echo "::warning::If 2FA is enabled on Docker Hub, you must use a PAT"
          }
        continue-on-error: true

      - name: Pull latest DHI base image
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true'
        run: |
          docker pull dhi.io/static:20230311
          echo "DHI base image updated to latest patch version"

      - name: Log in to Docker Hub (for Scout)
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Scan DHI base image for CVEs
        id: scout_scan
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true'
        uses: docker/scout-action@v1
        with:
          command: cves
          image: dhi.io/static:20230311
          sarif-file: dhi-base-cves.sarif
          summary: true
        continue-on-error: true

      - name: Get CVE counts
        id: cve_counts
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true'
        run: |
          # Parse the SARIF file to count vulnerabilities by severity
          if [ -f "dhi-base-cves.sarif" ]; then
            CRITICAL_COUNT=$(jq '[.runs[].results[] | select(.level == "error")] | length' dhi-base-cves.sarif 2>/dev/null || echo "0")
            HIGH_COUNT=$(jq '[.runs[].results[] | select(.level == "warning")] | length' dhi-base-cves.sarif 2>/dev/null || echo "0")
          else
            CRITICAL_COUNT=0
            HIGH_COUNT=0
          fi

          echo "critical_cves=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_cves=$HIGH_COUNT" >> $GITHUB_OUTPUT

          echo "Found $CRITICAL_COUNT CRITICAL and $HIGH_COUNT HIGH CVEs"

      - name: Upload SARIF results to GitHub Security
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true' && hashFiles('dhi-base-cves.sarif') != ''
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: dhi-base-cves.sarif
          category: dhi-base-image

      - name: Extract VEX attestations
        id: vex_check
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true'
        run: |
          # Extract VEX data to check for suppressed vulnerabilities
          docker scout attestation dhi.io/static:20230311 --type vex > dhi-vex.json || true

          if [ -s dhi-vex.json ]; then
            echo "vex_available=true" >> $GITHUB_OUTPUT
            VEX_COUNT=$(jq '[.statements[] | select(.status == "not_affected")] | length' dhi-vex.json)
            echo "vex_suppressed=$VEX_COUNT" >> $GITHUB_OUTPUT
            echo "VEX attestations found: $VEX_COUNT vulnerabilities marked as not_affected"
          else
            echo "vex_available=false" >> $GITHUB_OUTPUT
            echo "No VEX attestations available"
          fi

      - name: Calculate CVE SLA deadline
        id: sla_check
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true'
        run: |
          # Calculate 7-day SLA deadline for HIGH/CRITICAL CVEs
          CURRENT_DATE=$(date -u +%Y-%m-%d)
          SLA_DEADLINE=$(date -u -d "+7 days" +%Y-%m-%d)

          echo "current_date=$CURRENT_DATE" >> $GITHUB_OUTPUT
          echo "sla_deadline=$SLA_DEADLINE" >> $GITHUB_OUTPUT
          echo "7-day CVE remediation SLA deadline: $SLA_DEADLINE"

      - name: Create GitHub issue for HIGH/CRITICAL CVEs
        if: steps.dhi_auth.outputs.dhi_authenticated == 'true' && (steps.cve_counts.outputs.critical_cves > 0 || steps.cve_counts.outputs.high_cves > 0)
        uses: actions/github-script@v7
        with:
          script: |
            const criticalCount = ${{ steps.cve_counts.outputs.critical_cves }};
            const highCount = ${{ steps.cve_counts.outputs.high_cves }};
            const vexSuppressed = ${{ steps.vex_check.outputs.vex_suppressed || 0 }};
            const slaDeadline = '${{ steps.sla_check.outputs.sla_deadline }}';

            const issueTitle = `DHI CVE Alert: ${criticalCount} CRITICAL, ${highCount} HIGH vulnerabilities detected`;
            const issueBody = `# DHI Base Image CVE Alert

            ## Summary

            Automated CVE scan detected vulnerabilities in the DHI base image \`dhi.io/static:20230311\`.

            - **CRITICAL**: ${criticalCount}
            - **HIGH**: ${highCount}
            - **VEX Suppressed**: ${vexSuppressed} (non-exploitable)
            - **SLA Deadline**: ${slaDeadline} (7-day remediation SLA)

            ## Action Required

            1. Review CVE details in [Security tab](https://github.com/${{ github.repository }}/security/code-scanning)
            2. Check VEX attestations for exploitability analysis
            3. Monitor DHI for automated patch release
            4. Update base image when patch available
            5. Rebuild and redeploy application

            ## DHI Automated Remediation

            Docker Hardened Images provides automated patching with a 7-day SLA for HIGH/CRITICAL vulnerabilities:
            - DHI monitors base image 24/7
            - Patches published within 7 days
            - VEX attestations filter non-exploitable CVEs
            - SLSA Level 3 provenance for all patches

            ## Next Steps

            - [ ] Review CVE SARIF report in Security tab
            - [ ] Check VEX attestations (${vexSuppressed} already suppressed)
            - [ ] Monitor DHI for patch release
            - [ ] Test patched image in staging
            - [ ] Deploy to production

            ## Automation

            This issue was auto-generated by the DHI CVE monitoring workflow.
            Scan frequency: Every 6 hours
            Next scan: $(date -u -d "+6 hours" +"%Y-%m-%d %H:%M UTC")

            ## Related Files

            - Base Image: \`dhi.io/static:20230311\`
            - Dockerfile: \`/Dockerfile\` (line 53)
            - Workflow: \`.github/workflows/dhi-cve-monitor.yml\`
            - Security Validation: \`scripts/validate-dockerfile-security.sh\`
            `;

            // Check if similar issue already exists (open)
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'security,dhi-cve-alert'
            });

            if (issues.length === 0) {
              // Create new issue
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: issueTitle,
                body: issueBody,
                labels: ['security', 'dhi-cve-alert', 'high-priority']
              });
              console.log('Created new CVE alert issue');
            } else {
              // Update existing issue
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issues[0].number,
                body: `## Updated CVE Scan Results\n\nScan Date: $(date -u +"%Y-%m-%d %H:%M UTC")\n\n${issueBody}`
              });
              console.log('Updated existing CVE alert issue #' + issues[0].number);
            }

      - name: Summary report
        if: always()
        run: |
          echo "## DHI CVE Monitoring Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Scan Date:** $(date -u +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY
          echo "**Base Image:** dhi.io/static:20230311" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.dhi_auth.outputs.dhi_authenticated }}" != "true" ]; then
            echo "### Authentication Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Could not authenticate to dhi.io registry." >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Troubleshooting:**" >> $GITHUB_STEP_SUMMARY
            echo "- DHI uses Docker Hub credentials (Docker ID)" >> $GITHUB_STEP_SUMMARY
            echo "- If using a PAT, ensure it has at least 'Read only' scope" >> $GITHUB_STEP_SUMMARY
            echo "- If 2FA is enabled on Docker Hub, you must use a PAT (not password)" >> $GITHUB_STEP_SUMMARY
            echo "- Verify DOCKER_USERNAME and DOCKER_PASSWORD secrets are correct" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Documentation:** [Docker Hardened Images](https://docs.docker.com/dhi/)" >> $GITHUB_STEP_SUMMARY
          else
            echo "### Vulnerability Counts" >> $GITHUB_STEP_SUMMARY
            echo "- CRITICAL: ${{ steps.cve_counts.outputs.critical_cves || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
            echo "- HIGH: ${{ steps.cve_counts.outputs.high_cves || 'N/A' }}" >> $GITHUB_STEP_SUMMARY
            echo "- VEX Suppressed: ${{ steps.vex_check.outputs.vex_suppressed || 0 }}" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### SLA Tracking" >> $GITHUB_STEP_SUMMARY
            echo "- Current Date: ${{ steps.sla_check.outputs.current_date }}" >> $GITHUB_STEP_SUMMARY
            echo "- 7-Day Deadline: ${{ steps.sla_check.outputs.sla_deadline }}" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Scan" >> $GITHUB_STEP_SUMMARY
          echo "Scheduled: $(date -u -d "+6 hours" +"%Y-%m-%d %H:%M UTC")" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup
        if: always()
        run: |
          rm -f dhi-base-cves.sarif dhi-vex.json
          docker logout dhi.io
